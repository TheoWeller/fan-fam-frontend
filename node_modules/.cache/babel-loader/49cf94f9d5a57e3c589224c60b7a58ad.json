{"ast":null,"code":"/*\n * Ahoy.js\n * Simple, powerful JavaScript analytics\n * https://github.com/ankane/ahoy.js\n * v0.3.4\n * MIT License\n */\nimport objectToFormData from 'object-to-formdata'; // https://www.quirksmode.org/js/cookies.html\n\nvar Cookies = {\n  set: function (name, value, ttl, domain) {\n    var expires = \"\";\n    var cookieDomain = \"\";\n\n    if (ttl) {\n      var date = new Date();\n      date.setTime(date.getTime() + ttl * 60 * 1000);\n      expires = \"; expires=\" + date.toGMTString();\n    }\n\n    if (domain) {\n      cookieDomain = \"; domain=\" + domain;\n    }\n\n    document.cookie = name + \"=\" + escape(value) + expires + cookieDomain + \"; path=/\";\n  },\n  get: function (name) {\n    var i, c;\n    var nameEQ = name + \"=\";\n    var ca = document.cookie.split(';');\n\n    for (i = 0; i < ca.length; i++) {\n      c = ca[i];\n\n      while (c.charAt(0) === ' ') {\n        c = c.substring(1, c.length);\n      }\n\n      if (c.indexOf(nameEQ) === 0) {\n        return unescape(c.substring(nameEQ.length, c.length));\n      }\n    }\n\n    return null;\n  }\n};\nvar config = {\n  urlPrefix: \"\",\n  visitsUrl: \"/ahoy/visits\",\n  eventsUrl: \"/ahoy/events\",\n  page: null,\n  platform: \"Web\",\n  useBeacon: true,\n  startOnReady: true,\n  trackVisits: true,\n  cookies: true,\n  cookieDomain: null,\n  headers: {},\n  visitParams: {},\n  withCredentials: false\n};\nvar ahoy = window.ahoy || window.Ahoy || {};\n\nahoy.configure = function (options) {\n  for (var key in options) {\n    if (options.hasOwnProperty(key)) {\n      config[key] = options[key];\n    }\n  }\n}; // legacy\n\n\nahoy.configure(ahoy);\nvar $ = window.jQuery || window.Zepto || window.$;\nvar visitId, visitorId, track;\nvar visitTtl = 4 * 60; // 4 hours\n\nvar visitorTtl = 2 * 365 * 24 * 60; // 2 years\n\nvar isReady = false;\nvar queue = [];\nvar canStringify = typeof JSON !== \"undefined\" && typeof JSON.stringify !== \"undefined\";\nvar eventQueue = [];\n\nfunction visitsUrl() {\n  return config.urlPrefix + config.visitsUrl;\n}\n\nfunction eventsUrl() {\n  return config.urlPrefix + config.eventsUrl;\n}\n\nfunction isEmpty(obj) {\n  return Object.keys(obj).length === 0;\n}\n\nfunction canTrackNow() {\n  return (config.useBeacon || config.trackNow) && isEmpty(config.headers) && canStringify && typeof window.navigator.sendBeacon !== \"undefined\" && !config.withCredentials;\n} // cookies\n\n\nfunction setCookie(name, value, ttl) {\n  Cookies.set(name, value, ttl, config.cookieDomain || config.domain);\n}\n\nfunction getCookie(name) {\n  return Cookies.get(name);\n}\n\nfunction destroyCookie(name) {\n  Cookies.set(name, \"\", -1);\n}\n\nfunction log(message) {\n  if (getCookie(\"ahoy_debug\")) {\n    window.console.log(message);\n  }\n}\n\nfunction setReady() {\n  var callback;\n\n  while (callback = queue.shift()) {\n    callback();\n  }\n\n  isReady = true;\n}\n\nfunction ready(callback) {\n  if (isReady) {\n    callback();\n  } else {\n    queue.push(callback);\n  }\n}\n\nfunction matchesSelector(element, selector) {\n  var matches = element.matches || element.matchesSelector || element.mozMatchesSelector || element.msMatchesSelector || element.oMatchesSelector || element.webkitMatchesSelector;\n\n  if (matches) {\n    return matches.apply(element, [selector]);\n  } else {\n    log(\"Unable to match\");\n    return false;\n  }\n}\n\nfunction onEvent(eventName, selector, callback) {\n  document.addEventListener(eventName, function (e) {\n    if (matchesSelector(e.target, selector)) {\n      callback(e);\n    }\n  });\n} // http://beeker.io/jquery-document-ready-equivalent-vanilla-javascript\n\n\nfunction documentReady(callback) {\n  document.readyState === \"interactive\" || document.readyState === \"complete\" ? callback() : document.addEventListener(\"DOMContentLoaded\", callback);\n} // https://stackoverflow.com/a/2117523/1177228\n\n\nfunction generateId() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    var r = Math.random() * 16 | 0,\n        v = c == 'x' ? r : r & 0x3 | 0x8;\n    return v.toString(16);\n  });\n}\n\nfunction saveEventQueue() {\n  if (config.cookies && canStringify) {\n    setCookie(\"ahoy_events\", JSON.stringify(eventQueue), 1);\n  }\n} // from rails-ujs\n\n\nfunction csrfToken() {\n  var meta = document.querySelector(\"meta[name=csrf-token]\");\n  return meta && meta.content;\n}\n\nfunction csrfParam() {\n  var meta = document.querySelector(\"meta[name=csrf-param]\");\n  return meta && meta.content;\n}\n\nfunction CSRFProtection(xhr) {\n  var token = csrfToken();\n\n  if (token) {\n    xhr.setRequestHeader(\"X-CSRF-Token\", token);\n  }\n}\n\nfunction sendRequest(url, data, success) {\n  if (canStringify) {\n    if ($) {\n      $.ajax({\n        type: \"POST\",\n        url: url,\n        data: JSON.stringify(data),\n        contentType: \"application/json; charset=utf-8\",\n        dataType: \"json\",\n        beforeSend: CSRFProtection,\n        success: success,\n        headers: config.headers,\n        xhrFields: {\n          withCredentials: config.withCredentials\n        }\n      });\n    } else {\n      var xhr = new XMLHttpRequest();\n      xhr.open(\"POST\", url, true);\n      xhr.withCredentials = config.withCredentials;\n      xhr.setRequestHeader(\"Content-Type\", \"application/json\");\n\n      for (var header in config.headers) {\n        if (config.headers.hasOwnProperty(header)) {\n          xhr.setRequestHeader(header, config.headers[header]);\n        }\n      }\n\n      xhr.onload = function () {\n        if (xhr.status === 200) {\n          success();\n        }\n      };\n\n      CSRFProtection(xhr);\n      xhr.send(JSON.stringify(data));\n    }\n  }\n}\n\nfunction eventData(event) {\n  var data = {\n    events: [event]\n  };\n\n  if (config.cookies) {\n    data.visit_token = event.visit_token;\n    data.visitor_token = event.visitor_token;\n  }\n\n  delete event.visit_token;\n  delete event.visitor_token;\n  return data;\n}\n\nfunction trackEvent(event) {\n  ready(function () {\n    sendRequest(eventsUrl(), eventData(event), function () {\n      // remove from queue\n      for (var i = 0; i < eventQueue.length; i++) {\n        if (eventQueue[i].id == event.id) {\n          eventQueue.splice(i, 1);\n          break;\n        }\n      }\n\n      saveEventQueue();\n    });\n  });\n}\n\nfunction trackEventNow(event) {\n  ready(function () {\n    var data = eventData(event);\n    var param = csrfParam();\n    var token = csrfToken();\n\n    if (param && token) {\n      data[param] = token;\n    } // stringify so we keep the type\n\n\n    data.events_json = JSON.stringify(data.events);\n    delete data.events;\n    window.navigator.sendBeacon(eventsUrl(), objectToFormData(data));\n  });\n}\n\nfunction page() {\n  return config.page || window.location.pathname;\n}\n\nfunction presence(str) {\n  return str && str.length > 0 ? str : null;\n}\n\nfunction cleanObject(obj) {\n  for (var key in obj) {\n    if (obj.hasOwnProperty(key)) {\n      if (obj[key] === null) {\n        delete obj[key];\n      }\n    }\n  }\n\n  return obj;\n}\n\nfunction eventProperties(e) {\n  var target = e.target;\n  return cleanObject({\n    tag: target.tagName.toLowerCase(),\n    id: presence(target.id),\n    \"class\": presence(target.className),\n    page: page(),\n    section: getClosestSection(target)\n  });\n}\n\nfunction getClosestSection(element) {\n  for (; element && element !== document; element = element.parentNode) {\n    if (element.hasAttribute('data-section')) {\n      return element.getAttribute('data-section');\n    }\n  }\n\n  return null;\n}\n\nfunction createVisit() {\n  isReady = false;\n  visitId = ahoy.getVisitId();\n  visitorId = ahoy.getVisitorId();\n  track = getCookie(\"ahoy_track\");\n\n  if (config.cookies === false || config.trackVisits === false) {\n    log(\"Visit tracking disabled\");\n    setReady();\n  } else if (visitId && visitorId && !track) {\n    // TODO keep visit alive?\n    log(\"Active visit\");\n    setReady();\n  } else {\n    if (!visitId) {\n      visitId = generateId();\n      setCookie(\"ahoy_visit\", visitId, visitTtl);\n    } // make sure cookies are enabled\n\n\n    if (getCookie(\"ahoy_visit\")) {\n      log(\"Visit started\");\n\n      if (!visitorId) {\n        visitorId = generateId();\n        setCookie(\"ahoy_visitor\", visitorId, visitorTtl);\n      }\n\n      var data = {\n        visit_token: visitId,\n        visitor_token: visitorId,\n        platform: config.platform,\n        landing_page: window.location.href,\n        screen_width: window.screen.width,\n        screen_height: window.screen.height,\n        js: true\n      }; // referrer\n\n      if (document.referrer.length > 0) {\n        data.referrer = document.referrer;\n      }\n\n      for (var key in config.visitParams) {\n        if (config.visitParams.hasOwnProperty(key)) {\n          data[key] = config.visitParams[key];\n        }\n      }\n\n      log(data);\n      sendRequest(visitsUrl(), data, function () {\n        // wait until successful to destroy\n        destroyCookie(\"ahoy_track\");\n        setReady();\n      });\n    } else {\n      log(\"Cookies disabled\");\n      setReady();\n    }\n  }\n}\n\nahoy.getVisitId = ahoy.getVisitToken = function () {\n  return getCookie(\"ahoy_visit\");\n};\n\nahoy.getVisitorId = ahoy.getVisitorToken = function () {\n  return getCookie(\"ahoy_visitor\");\n};\n\nahoy.reset = function () {\n  destroyCookie(\"ahoy_visit\");\n  destroyCookie(\"ahoy_visitor\");\n  destroyCookie(\"ahoy_events\");\n  destroyCookie(\"ahoy_track\");\n  return true;\n};\n\nahoy.debug = function (enabled) {\n  if (enabled === false) {\n    destroyCookie(\"ahoy_debug\");\n  } else {\n    setCookie(\"ahoy_debug\", \"t\", 365 * 24 * 60); // 1 year\n  }\n\n  return true;\n};\n\nahoy.track = function (name, properties) {\n  // generate unique id\n  var event = {\n    name: name,\n    properties: properties || {},\n    time: new Date().getTime() / 1000.0,\n    id: generateId(),\n    js: true\n  };\n  ready(function () {\n    if (config.cookies && !ahoy.getVisitId()) {\n      createVisit();\n    }\n\n    ready(function () {\n      log(event);\n      event.visit_token = ahoy.getVisitId();\n      event.visitor_token = ahoy.getVisitorId();\n\n      if (canTrackNow()) {\n        trackEventNow(event);\n      } else {\n        eventQueue.push(event);\n        saveEventQueue(); // wait in case navigating to reduce duplicate events\n\n        setTimeout(function () {\n          trackEvent(event);\n        }, 1000);\n      }\n    });\n  });\n  return true;\n};\n\nahoy.trackView = function (additionalProperties) {\n  var properties = {\n    url: window.location.href,\n    title: document.title,\n    page: page()\n  };\n\n  if (additionalProperties) {\n    for (var propName in additionalProperties) {\n      if (additionalProperties.hasOwnProperty(propName)) {\n        properties[propName] = additionalProperties[propName];\n      }\n    }\n  }\n\n  ahoy.track(\"$view\", properties);\n};\n\nahoy.trackClicks = function () {\n  onEvent(\"click\", \"a, button, input[type=submit]\", function (e) {\n    var target = e.target;\n    var properties = eventProperties(e);\n    properties.text = properties.tag == \"input\" ? target.value : (target.textContent || target.innerText || target.innerHTML).replace(/[\\s\\r\\n]+/g, \" \").trim();\n    properties.href = target.href;\n    ahoy.track(\"$click\", properties);\n  });\n};\n\nahoy.trackSubmits = function () {\n  onEvent(\"submit\", \"form\", function (e) {\n    var properties = eventProperties(e);\n    ahoy.track(\"$submit\", properties);\n  });\n};\n\nahoy.trackChanges = function () {\n  onEvent(\"change\", \"input, textarea, select\", function (e) {\n    var properties = eventProperties(e);\n    ahoy.track(\"$change\", properties);\n  });\n};\n\nahoy.trackAll = function () {\n  ahoy.trackView();\n  ahoy.trackClicks();\n  ahoy.trackSubmits();\n  ahoy.trackChanges();\n}; // push events from queue\n\n\ntry {\n  eventQueue = JSON.parse(getCookie(\"ahoy_events\") || \"[]\");\n} catch (e) {// do nothing\n}\n\nfor (var i = 0; i < eventQueue.length; i++) {\n  trackEvent(eventQueue[i]);\n}\n\nahoy.start = function () {\n  createVisit();\n\n  ahoy.start = function () {};\n};\n\ndocumentReady(function () {\n  if (config.startOnReady) {\n    ahoy.start();\n  }\n});\nexport default ahoy;","map":null,"metadata":{},"sourceType":"module"}